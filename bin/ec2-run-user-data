#!/bin/bash
#
# ec2-run-user-data - Run instance user-data if it looks like a script.
#
# Only runs on the first boot of an instance.  If you want the
# user-data script to run again on the next boot, add this command in
# the user-data script:
#   rm -f /var/ec2/ec2-run-user-data.*
#

prog=$(basename $0)
true ${prog:=ec2}
logger="logger -t $prog"
curl="curl --retry 10 --retry-delay 2 --silent --show-error --fail --verbose"
instancedataurl=http://169.254.169.254/2008-02-01

# Exit if we have already run on this instance (previous boot).
$logger "Retrieving AMI id"
amiidurl=$instancedataurl/meta-data/ami-id
curlerrfile=/tmp/curlerr.$$
amiid=$($curl $amiidurl 2>/$curlerrfile)
$logger <$curlerrfile
rm -f $curlerrfile
$logger "AMI id: ${amiid:=unknown}"
beenrunfile=/var/ec2/$prog.$amiid
mkdir -p $(dirname $beenrunfile)
if [ -f $beenrunfile ]; then
  $logger "user-data has already been run run on this instance"
  exit
fi

# Retrieve the user-data
userdataurl=$instancedataurl/user-data
userdatafile=/tmp/$prog.$$
$logger "Retrieving user-data"
$curl -o $userdatafile $userdataurl 2>&1 | $logger

# Run the user-data if it looks like a script
if [ ! -e $userdatafile ]; then
  $logger "No user-data available"
elif head -1 $user_data_script | egrep -v '^#!'; then
  $logger "user-data does not start with #!"
else
  echo "user-data has been run on this instance under $amiid" >$beenrunfile
  $logger "Running user-data"
  chmod +x $userdatafile
  $userdatafile 2>&1 | $logger
  $logger "user-data exit code: $?"
fi
rm -f $userdatafile
